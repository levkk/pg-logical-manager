language: python
dist: xenial
python:
  - "3.7"
install:
  - pip install -r requirements.txt
  - pip install -r requirements-dev.txt
before_install:
  - sudo su postgres -c $'psql -c "ALTER SYSTEM SET wal_level = \'logical\'"'
  - sudo su postgres -c $'psql -c "ALTER SYSTEM SET max_replication_slots = 10;"'
  - sudo /etc/init.d/postgresql restart 10
script:
  - sudo su postgres -c "psql -c 'CREATE DATABASE src;'"
  - sudo su postgres -c "psql -c 'CREATE DATABASE dest;'"
  - sudo su postgres -c "psql src -c 'CREATE TABLE test (id serial);'"
  - sudo su postgres -c "psql dest -c 'CREATE TABLE test (id bigserial);'"
  - python -m pglogicalmanager configure --source=postgres://localhost:5432/src --destination=postgres://localhost:5432/dest
  - python -m pglogicalmanager list-subscriptions
  - python -m pglogicalmanager list-tables --source
  - python -m pglogicalmanager list-tables --destination
  - python -m pglogicalmanager list-columns test --source
  - python -m pglogicalmanager list-columns test --destination
  - python -m pglogicalmanager create-subscription test_sub
  - python -m pglogicalmanager list-subscriptions
  - python -m pglogicalmanager disable-subscription test_sub
  - python -m pglogicalmanager enable-subscription test_sub
  - python -m pglogicalmanager drop-subscription test_sub
  - pytest

addons:
  postgresql: "10"
  apt:
    packages:
    - postgresql-10
    - postgresql-client-10
